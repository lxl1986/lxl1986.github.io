<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Just Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="None">
<meta name="keywords" content="None">
<meta property="og:type" content="website">
<meta property="og:title" content="Just Blog">
<meta property="og:url" content="https://lxl1986.github.io/index.html">
<meta property="og:site_name" content="Just Blog">
<meta property="og:description" content="None">
<meta property="og:locale" content="zh">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just Blog">
<meta name="twitter:description" content="None">
  
    <link rel="alternate" href="/atom.xml" title="Just Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Just Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">None</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://lxl1986.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-scrollLeft" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/24/scrollLeft/" class="article-date">
  <time datetime="2019-01-24T03:09:51.000Z" itemprop="datePublished">2019-01-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/24/scrollLeft/">scrollLeft</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>闲来无事。发现自己没有……没有……没有亲手写过 <strong>无缝滚动</strong> ！！！ <strong>ZZ</strong> 一样的混等。</p>
<figure class="highlight html"><figcaption><span>scrollLeft</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">		scroll Left (￢_￢) Right</span><br><span class="line">	<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">		#demo &#123;</span></span><br><span class="line"><span class="undefined">			width: 500px;</span></span><br><span class="line"><span class="undefined">			border: 1px dashed red;</span></span><br><span class="line"><span class="undefined">			overflow: hidden;</span></span><br><span class="line"><span class="undefined">			overflow-x: scroll;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		table &#123;			</span></span><br><span class="line"><span class="undefined">			border-collapse: collapse;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		td &#123;</span></span><br><span class="line"><span class="undefined">			padding: 0;			</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">		.div &#123;</span></span><br><span class="line"><span class="undefined">			width: 125px;</span></span><br><span class="line"><span class="undefined">			height: 100px;</span></span><br><span class="line"><span class="undefined">			background-image: linear-gradient(32deg, aqua, black, cyan, deeppink, fuchsia, gold, hotpink, indigo);</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">		</span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>	</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 容器 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span> <span class="attr">data-comment</span>=<span class="string">"this is scroll container"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 放个表格，样式很简洁，宽度自动增加。其中第一列为需要滚动的内容。 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span>&gt;</span>			</span><br><span class="line">			<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- 展示内容要比容器长，否则，没有必要滚动，（尽管也可以滚动） --&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- 细节，比如第一张图片还没有出去；新复制的第一张也不该显示出来 --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">"listA"</span> <span class="attr">data-comment</span>=<span class="string">"origin content, column one"</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">						<span class="comment">&lt;!-- 如果内容直接复制在 #tRow 中，就不需要外层表格了 --&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tr</span> <span class="attr">id</span>=<span class="string">"tRow"</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">									1</span><br><span class="line">								<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">									2</span><br><span class="line">								<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">									3</span><br><span class="line">								<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">									4</span><br><span class="line">								<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">									5</span><br><span class="line">								<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">td</span>&gt;</span>						</span><br><span class="line">						<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">"listB"</span> <span class="attr">data-comment</span>=<span class="string">"cloned content, column two"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">				</span></span><br><span class="line"><span class="javascript">		(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> 复制一份滚动内容(<span class="params"></span>) </span>&#123; <span class="comment">//没什么卵用。随意写。</span></span></span><br><span class="line"><span class="undefined">			listB.innerHTML = listA.innerHTML;</span></span><br><span class="line"><span class="undefined">		&#125;());</span></span><br><span class="line"><span class="undefined">				</span></span><br><span class="line"><span class="javascript">		<span class="comment">//假设 每秒移动 100px，</span></span></span><br><span class="line"><span class="javascript">		<span class="comment">//再假设 移动频率 25, 即 40ms 移动一次。</span></span></span><br><span class="line"><span class="javascript">		<span class="comment">//那么移动量 5</span></span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> deltaT = <span class="number">40</span>; <span class="comment">//时间间隔</span></span></span><br><span class="line"><span class="javascript">		<span class="keyword">var</span> deltaX = <span class="number">5</span>;  <span class="comment">//这就是每次移动量，正整数。</span></span></span><br><span class="line"><span class="javascript">		<span class="function"><span class="keyword">function</span> <span class="title">goLeft</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(demo.scrollLeft &gt;= listA.offsetWidth) &#123;</span></span><br><span class="line"><span class="undefined">				demo.scrollLeft -= listA.offsetWidth;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">			demo.scrollLeft += deltaX;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="function"><span class="keyword">function</span> <span class="title">goRight</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">			<span class="keyword">if</span>(demo.scrollLeft &lt; listA.offsetWidth - demo.clientWidth) &#123;</span></span><br><span class="line"><span class="undefined">				demo.scrollLeft += listA.offsetWidth;</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">			</span></span><br><span class="line"><span class="undefined">			demo.scrollLeft += -deltaX;</span></span><br><span class="line"><span class="undefined">		&#125;</span></span><br><span class="line"><span class="undefined">		</span></span><br><span class="line"><span class="javascript">		<span class="comment">//setInterval(goLeft, deltaT);</span></span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="分析一下"><a href="#分析一下" class="headerlink" title="分析一下"></a>分析一下</h2><p>我们这里用 scrollLeft 来实现。分析清楚以后，offsetLeft细节虽然不同，但道理是一样。</p>
<img src="/2019/01/24/scrollLeft/d1.svg" class="示意1">
<ol>
<li><p>假设容器宽度为 <span style="background-color:deeppink;color:white;">&emsp;W&emsp;</span>，内容宽度为 <span style="background-color:red;color:white;">&emsp;L&emsp;</span>。（满足 L &gt; W，我觉得 L &lt;= W 没必要无缝滚动，你非要滚动请自行设计。)<br>假设容器的scrollLeft值为 x，开始，x = 0；然后 x 不停增加，一直移动到右边 x = L - W（滚不动了，x大于 L-W，也会被设置为 L-W）。<br>x ∈ [0, L-W] ⊂ N。</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollLeft" target="_blank" rel="noopener">Element.scrollLeft</a>，那个rtl我在 Chrome 71.0.3578.98 测试，和描述不符。不兼容吧。我们这里不要理会 rtl。 </li>
</ul>
</li>
<li><p>我们要的效果</p>
</li>
</ol>
<img src="/2019/01/24/scrollLeft/d2.svg" class="示意2">
<p>为了能让红色块滚出去，我们把它复制一份，蓝色的。 此时 x ∈ [0, 2L-W]。</p>
<p>显然，开始x=0，不断增加 x，内容就向左滚动了，当 x&gt;=L 时，红色块滚了出去，显示的是蓝色块部分内容。关键是，蓝色块和红色块的长相是一样的。如果我们滚出了红色块，进入了蓝色块，我们只要马上跳转到相应的红色块位置即可。</p>
<p><strong>当 x ∈ [L, 2L-W]，显示的是蓝色块。 显示范围对应于 [x, x+W-1]，由于周期性，它与 [x-L, (x+W-1)-L] 显示完全一样。</strong> 这就是无缝而动的本质。</p>
<p>那么这一句跳回去，<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(demo.scrollLeft &gt;= listA.offsetWidth) &#123;</span><br><span class="line">		demo.scrollLeft -= listA.offsetWidth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以改为<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> L = listA.offsetWidth;</span><br><span class="line"><span class="keyword">const</span> W = demo.clientWidth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MIN = L;</span><br><span class="line"><span class="keyword">const</span> MAX = <span class="number">2</span>*L - W;</span><br><span class="line"><span class="keyword">const</span> RANGE = MAX - MIN;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳转条件</span></span><br><span class="line"><span class="keyword">const</span> BOUNDARY = MIN + <span class="built_in">Math</span>.round(RANGE * <span class="built_in">Math</span>.random());</span><br><span class="line"><span class="keyword">if</span>(demo.scrollLeft &gt;= BOUNDARY) &#123;</span><br><span class="line">		demo.scrollLeft -= listA.offsetWidth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="动起来？"><a href="#动起来？" class="headerlink" title="动起来？"></a>动起来？</h2><ol start="3">
<li>deltaX 多大？ 每一次移动，走多少距离合适？</li>
</ol>
<p>因为 x ∈ [0, 2L-W]，显然，1 &lt;= deltaX &lt;= 2L-W。</p>
<ul>
<li><p>deltaX=1 看起来就很好用。</p>
</li>
<li><p>再看deltaX=2L-W。你一下滚到头了。步子迈得太大，容易扯蛋。初始 x=0</p>
<ul>
<li>第一次 goLeft 后，x=2L-W，</li>
<li>第二次 goLeft 后，x=2L-W，(满足跳转条件，x减去L，即 x=L-W，加个deltaX，3L-2W，过头了，又变成了 2L-W，x=2L-W) </li>
<li>第三次 goLeft 后，x=2L-W，同上</li>
<li>……<br>完全没有动画效果，而且我认为这个deltaX无效，为啥？后面每次都加过头了。瞎几把搞。</li>
</ul>
</li>
<li><p>deltaX上限多少？就是每次加上去都不会过头。</p>
</li>
</ul>
<p>也就是每次 goLeft 都满足表达式 <em>x + deltaX &lt;= 2L-W</em>。<br>如果用 <code>demo.scrollLeft &gt;= BOUNDARY</code>，会很复杂。我们就简化一下，还是用原来的，<code>demo.scrollLeft &gt;= listA.offsetWidth</code>，即 x 大于等于 L 时，就需要减去 L，然后再计算上面的表达式。</p>
<p>假设：<br>x<sub>m-1</sub> &lt; L,<br>x<sub>m</sub> &gt;= L,<br>其中 x<sub>0</sub>=0，x<sub>n</sub> = x<sub>n-1</sub> + deltaX，</p>
<p>由于 x<sub>m</sub> 满足跳转条件，此时 x=x<sub>m</sub> - L，</p>
<p>(x<sub>m</sub> - L) + deltaX &lt;= 2L-W, 令 x<sub>m</sub>=2L-W，得 deltaX &lt;= L;<br>(x<sub>m-1</sub> + delataX - L) + deltaX &lt;= 2L-W, 令 x<sub>m-1</sub>=L-1，得 deltaX &lt;= L - 0.5W + 0.5</p>
<p>同时 deltaX = x<sub>m</sub> - x<sub>m-1</sub> = (2L-W) - (L-1) = L - W + 1</p>
<p>所以 当 deltaX 小于 L-W+1 时，是有效的；而当 deltaX 小于 2L-W 时，是合理的。因为 scrollLeft 有自己的上限。</p>
<ol start="4">
<li>怎么动起来？我们取 deltaX 为个位数就行了，一般 L 都要比 W 大。频率取值大于24（人眼？），小于60（显示器刷新？）即可。 即16ms &lt; deltaT &lt; 42ms。若 deltaT=25，deltaX=4，大概每秒能移动160距离。当 deltaT不变时，deltaX变化就能调整速度，比如 <code>deltaX=10</code> 或者 <code>deltaX=Math.round((L-W+1)*Math.random())</code>;</li>
</ol>
<p>然后， setInterval(goLeft, deltaT) 就完事了。</p>
<p>向右，向上，向下，斜着滚动，都可以做同样的分析。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2019/01/24/scrollLeft/" data-id="cjrbs3fjl001bycv9yyxi6bd4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scroll/">scroll</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-a-little-note-about-load-event" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/21/a-little-note-about-load-event/" class="article-date">
  <time datetime="2019-01-21T00:50:45.000Z" itemprop="datePublished">2019-01-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/21/a-little-note-about-load-event/">a little note about load event</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="废话不说，上码。"><a href="#废话不说，上码。" class="headerlink" title="废话不说，上码。"></a>废话不说，上码。</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s1"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="built_in">console</span>.log(<span class="string">'window: '</span>, <span class="built_in">window</span>, <span class="string">'document: '</span>, <span class="built_in">document</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> <span class="attr">id</span>=<span class="string">"cs"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s2"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="built_in">console</span>.log(<span class="string">'charset: '</span>, cs);</span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>  <span class="attr">id</span>=<span class="string">"s3"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">		<span class="built_in">console</span>.log(<span class="string">'document.html: '</span>, <span class="built_in">document</span>.documentElement);</span></span><br><span class="line"><span class="undefined">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s4"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">console</span>.log(<span class="string">'document.head: '</span>, <span class="built_in">document</span>.head, <span class="built_in">document</span>.head.children); <span class="comment">//特别注意这一句，此时title还没有</span></span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">			A title (￢_￢)</span><br><span class="line">			<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'document.title???: '</span>, <span class="built_in">document</span>.title);</span></span><br><span class="line"><span class="undefined">			</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s5"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'document.title: '</span>, <span class="built_in">document</span>.title);</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s6"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'document.body???: '</span>, <span class="built_in">document</span>.body); <span class="comment">//no body</span></span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s7"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'document.body: '</span>, <span class="built_in">document</span>.body); <span class="comment">//yes body</span></span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s8"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'div: '</span>, div);	</span></span><br><span class="line"><span class="undefined">			</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"s9"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(<span class="string">'p: '</span>, p);	</span></span><br><span class="line"><span class="undefined">				</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这就是辣鸡代码。不过，我仅仅是为了展现一下 DOM 生成的一个侧面。可以看到有的对象很早就存在了，比如window；然而<code>document.body</code>生于<code>&lt;body&gt;</code>后，可以看到 #s7有，#s6没有。</p>
<img src="/2019/01/21/a-little-note-about-load-event/garbage.png" title="garbage">
<p>看那个 <code>HTMLCollection(5)</code>，<em>当时 head 已有，并且只有5个子元素，后面的3个子元素还未生成</em> （可在head开始和结束分别输出子元素个数）。不过这是一个<strong>动态</strong>的聚合，后来在控制台就全部打印出来了。不扯蛋了。</p>
<h2 id="load-事件部分简单分析，说说-onload"><a href="#load-事件部分简单分析，说说-onload" class="headerlink" title="load 事件部分简单分析，说说 onload"></a>load 事件部分简单分析，说说 onload</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">onload</span>=<span class="string">"console.log(`html`);"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span> <span class="attr">onload</span>=<span class="string">"console.log(`head`);"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">			A title (￢_￢)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"console.log('body');"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div"</span> <span class="attr">onload</span>=<span class="string">"console.log('div');"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p"</span> <span class="attr">onload</span>=<span class="string">"console.log('p');"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只有body有效果，其他没什么卵用。（<strong>不考虑其他资源标签，比如 img，video，audio，script……</strong>）</p>
<p>但是从另一个角度，也可以理解为，浏览器没有为这类元素提供 load事件。（关键也没有必要提供）。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">			A title (￢_￢)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'window: '</span>, e);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"console.log('on body: ', event);"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">document</span>.body.onload = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'in body: '</span>, e);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>此时只有最后一句有效果，其他被覆盖。也可以说，三句是等价的，有一句就够了。这里别用 addEventListener，情况会更加复杂。</p>
<p>咋回事？</p>
<p>可以一句一句实验，打印 event。</p>
<p>可以发现，这三句都满足： event.target === document，event.currentTarget === window。</p>
<p>用 Chrome 打出来看看：</p>
<img src="/2019/01/21/a-little-note-about-load-event/load.png" title="load">
<p>这个 load事件，它的 target 是 document；但是它的 <strong><em>propagation path</em></strong> 只有 window！！！ 也就是说这个 load事件 传播到 window，没有然后了。可能由于历史原因，body上的 onload处理，实际是放到了 window 上面，但是 <code>document.body.addEventListener(&#39;load&#39;, /\*...\*/)</code>，却监听在document.body上（可惜，传播只到window！你听不到啊！•﹏•）；而在其他元素上挂 onload 是没啥用了。</p>
<p>按理来说，你好歹，这个 load事件，从 window-&gt;document-&gt;window，经历三阶段；实际只有 eventPhase===2，这个阶段。</p>
<h2 id="load实验"><a href="#load实验" class="headerlink" title="load实验"></a>load实验</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> e1 = <span class="keyword">new</span> Event(<span class="string">'load'</span>, &#123;</span><br><span class="line">	bubbles: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, e=&gt;&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'window: '</span>, e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'load'</span>, e=&gt;&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'d: '</span>, e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.documentElement.addEventListener(<span class="string">'load'</span>, e=&gt;&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'d-html: '</span>, e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.addEventListener(<span class="string">'load'</span>, e=&gt;&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'d-body: '</span>, e);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.dispatchEvent(e1);</span><br></pre></td></tr></table></figure>
<p>我这个 e1 是没有传播到 window。和自定义事件一点不熟，还得搞一搞。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">			A title (￢_￢)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">title</span>&gt;</span>		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"p"</span> <span class="attr">onload</span>=<span class="string">"alert('p')"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">document</span>.currentScript.onload =  <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123; </span></span><br><span class="line"><span class="javascript">				<span class="built_in">console</span>.log(<span class="string">'me : '</span>, e);</span></span><br><span class="line"><span class="undefined">			&#125;</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 这个用法可能是错误的，load 应该用在带有 src 的 script 上，或者监测一个带有 async 的 script？</span></span></span><br><span class="line"><span class="javascript">			<span class="comment">// 不过，这句即使正确。也只有加载完了，才会执行这里。 但是加载完（load事件也产生过了），执行这里也没啥用鸟。</span></span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">			<span class="built_in">document</span>.body.onload = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;&#125;;</span></span><br><span class="line"><span class="javascript">			<span class="built_in">document</span>.body.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;&#125;);</span></span><br><span class="line"><span class="javascript">			<span class="comment">// 第一个加到 window 上，不仅仅是历史原因</span></span></span><br><span class="line"><span class="javascript">			<span class="comment">// 第二个加到 document.body 上</span></span></span><br><span class="line"><span class="javascript">			<span class="comment">// 仅仅是一个思路，未测试全部浏览器</span></span></span><br><span class="line"><span class="undefined">		</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>很多地方都在胡说八道，看看就算了，别当真。</p>
<h2 id="补充-（2019年1月22日08-31-55）"><a href="#补充-（2019年1月22日08-31-55）" class="headerlink" title="补充 （2019年1月22日08:31:55）"></a>补充 （2019年1月22日08:31:55）</h2><p>window.onload 和 body onload</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.body.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(e, <span class="keyword">this</span> === <span class="built_in">window</span>); <span class="comment">// true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.onclick = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(e, <span class="keyword">this</span>=== <span class="built_in">document</span>.body) <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>感觉自己很蠢。这样不就行了。 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"console.log(this===window)"</span>&gt;</span> <span class="comment">&lt;!-- true --&gt;</span></span><br></pre></td></tr></table></figure>
<p>看上面两段代码，和我昨天说的一样，这样更明显。昨天从 load事件出发、今天从 this 出发，都证明了 window.onload 和 body onload 等价。（未测试所有浏览器，记得吆！！！）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2019/01/21/a-little-note-about-load-event/" data-id="cjrbs3fhc0001ycv94jxwuxb7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/events-load/">events load</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-event-fired" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/18/event-fired/" class="article-date">
  <time datetime="2019-01-18T00:31:06.000Z" itemprop="datePublished">2019-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/18/event-fired/">event fired?</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>关于事件的产生。就拿鼠标相关事件搞一搞。</p>
<h2 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h2><p>当移动鼠标，点击鼠标的时候，OS 是会分发消息的（就说 win32 GUI 吧，或许有其他特例）。至于怎么处理就是应用的事情。（当然 OS 自身作为一个大应用也处理自己该处理的消息。）</p>
<h2 id="事件对象"><a href="#事件对象" class="headerlink" title="事件对象"></a>事件对象</h2><p>假如我在浏览器中晃动、点击鼠标，那么 OS 就会把鼠标消息派发给浏览器。此时，关于浏览器中鼠标相关事件（一个事件就是一个JS中的对象，就像这样 <code>{target: xxoo, bubbles: true, type: &#39;click&#39;, cancelable:true, path: ooxx, /* ... */}</code>，不同事件对象含有不同信息；一个数据结构而已）的产生我产生了以下的疑问。</p>
<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/click" target="_blank" rel="noopener">click</a></li>
</ol>
<p>The <strong>click</strong> event fires when a pointing device button (e.g., a mouse’s primary button) is pressed and released on a single element. If the button is pressed on one element and released on a different one, the event is fired on the most specific ancestor element that contained both.</p>
<p>click fires after the mousedown and mouseup events, in that order.</p>
<p>我的理解就是：我点了鼠标，浏览器就生成了 click事件，管它有没有谁监听，即使没人理，也要传递一遍。</p>
<ol start="2">
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/mouseover" target="_blank" rel="noopener">mouseover</a></li>
</ol>
<p>The <strong>mouseover</strong> event is fired when a pointing device is moved onto the element that has the listener attached or onto one of its children.</p>
<p>移动鼠标，浏览器不一定产生 mouseover事件；只有相关元素监听了 <code>mouseover</code>这类事件，你再去 over，浏览器才会产生 mousemove事件。（这和 click就不一样了；得监听了才有）</p>
<ol start="3">
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/mouseenter" target="_blank" rel="noopener">mouseenter</a></li>
</ol>
<p>The <strong>mouseenter</strong> event is fired when a pointing device (usually a mouse) is moved over the element that has the listener attached.</p>
<p>Though similar to mouseover, it differs in that it doesn’t bubble and that it isn’t sent to any descendants when the pointer is moved from one of its descendants’ physical space to its own physical space.</p>
<p>下面的图，和图下面的话，我不敢苟同。图中左边和右边情况都不明了，有啥可比性？左边四层div都挂了 mouseenter？还是右边最外层div挂了一个mouseover？</p>
<p>假设左边四层div都挂了 mouseenter，右边最外层div挂了 mouseover。 （默认排版，不加多余样式。）</p>
<ul>
<li>如果 Text 所处的位置在 他们内部，左边进去到Text上就依次产生了四个 mouseenter事件；右边进去也产生了四个 mouseover事件，每个还冒泡。</li>
<li>如果 Text 所处的位置在 他们外部（比如 fixed 设定位置），那么移动到Text上，左边依次产生了4个事件。右边产生一个事件，冒泡上去。</li>
</ul>
<ol start="4">
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Events/mousemove" target="_blank" rel="noopener">mousemove</a></li>
</ol>
<p>The <strong>mousemove</strong> event is fired when a pointing device (usually a mouse) is moved while over an element.</p>
<p>这……我在一个元素上晃鼠标，就产生 mousemove事件吗？ <em>over</em>和<em>enter</em>至少说了需要<em>listener</em>，这个，居然啥也没说？</p>
<h2 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h2><p>就抄这么多了。</p>
<ol>
<li>事件的产生</li>
</ol>
<p>我 click, over, enter, move 时，产生事件有啥条件？</p>
<p>从上面抄的来看，click，就会产生 click事件。这个事件对象的产生没啥要求？即使没有注册一个监听函数？那么这个 click事件 就是打酱油？啥也不干？那要它有何用？当页面单独放一个 checkbox 的时候，点击它，有反应，说明浏览器内部还是有监听的。</p>
<ol start="2">
<li>事件的传播</li>
</ol>
<p>这个三阶段模型也怪怪的。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">        gg</span><br><span class="line">    <span class="tag">&lt;/<span class="name">title</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"test"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">id</span>=<span class="string">"cb"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    	<span class="comment">// C capture, B bubble.</span></span></span><br><span class="line"><span class="javascript">        cb.addEventListener(<span class="string">'click'</span>, e=&gt;&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'cb '</span>, e.eventPhase, e.path);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        test.addEventListener(<span class="string">'click'</span>, e=&gt;&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'test C '</span>, e.eventPhase, e.path)</span></span><br><span class="line"><span class="javascript">        &#125;, <span class="literal">true</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        test.addEventListener(<span class="string">'click'</span>, e=&gt;&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'test B '</span>, e.eventPhase, e.path);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="built_in">window</span>.addEventListener(<span class="string">'click'</span>, e=&gt;&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'w C '</span>, e.eventPhase, e.path);</span></span><br><span class="line"><span class="javascript">        &#125;, <span class="literal">true</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">        <span class="built_in">window</span>.addEventListener(<span class="string">'click'</span>, e=&gt;&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'w B '</span>, e.eventPhase, e.path);</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>任意一个都可以加 <code>e.stopPropagation()</code>，不影响 checkbox 能否选中，影响click事件传播；如果有一个加了 <code>e.preventDefault()</code>，就会影响 checkbox 选中对号，<code>cb.checked === false</code>，也就是不能选中，但不影响click事件传播。</p>
<p>事件非要从window一路下来，一个不拉到达目标？我如果一个事件监听函数都不注册，点击 checkbox，click事件还真的会千辛万苦<br><code>window-&gt;document-&gt;html-&gt;body-&gt;div#test-&gt;input#cb-&gt;div#test-&gt;body-&gt;html-&gt;document-&gt;window</code> 走一圈？何必呢？一个事件的生命周期有多久？走到头或者stop就消散了吗？</p>
<p>未完待续。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2019/01/18/event-fired/" data-id="cjrbs3fi60009ycv9im4c7h6t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/events/">events</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-checkbox-notes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/17/checkbox-notes/" class="article-date">
  <time datetime="2019-01-17T03:51:06.000Z" itemprop="datePublished">2019-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/17/checkbox-notes/">checkbox notes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>偷窥<a href="https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent" target="_blank" rel="noopener">MouseEvent</a>的时候，就把栗子抄了过来</p>
<p>1.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">id</span>=<span class="string">"label"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">id</span>=<span class="string">"checkbox"</span>&gt;</span> Checked<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> evt = <span class="keyword">new</span> MouseEvent(<span class="string">"click"</span>, &#123;</span></span><br><span class="line"><span class="javascript">		bubbles: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">		cancelable: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">		view: <span class="built_in">window</span></span></span><br><span class="line"><span class="undefined">	&#125;);</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> cb = <span class="built_in">document</span>.getElementById(<span class="string">"checkbox"</span>);</span></span><br><span class="line"><span class="undefined">	cb.dispatchEvent(evt);  </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这里调用了一次 <code>cb.dispatchEvent(evt);</code> 就可以选中复选框。可是我又疯狂的调用 <code>cb.dispatchEvent(evt);</code> 没有什么效果。</p>
<p>然后我只能把 evt 再赋值一次，然后 dispatch 就好了。每次dispatch之前，evt要是全新的。这样才能选中、取消。</p>
<p>不知为何，每次需要刷新 evt？ 和 evt.timeStamp 有关系吗？对这里的自定义事件不是很清楚。</p>
<p>2.<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">id</span>=<span class="string">"label"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">id</span>=<span class="string">"checkbox"</span>&gt;</span> Checked<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    label.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(e.target===<span class="keyword">this</span>) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'label target'</span>);</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'label capture'</span>)</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;, <span class="literal">true</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    label.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(e.target===<span class="keyword">this</span>) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'label target'</span>);</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'label bubble'</span>);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">    &#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.addEventListener(<span class="string">'click'</span>, (e) =&gt; &#123;        </span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'window capture'</span>);        </span></span><br><span class="line"><span class="javascript">    &#125;, <span class="literal">true</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.addEventListener(<span class="string">'click'</span>, (e) =&gt; &#123;        </span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'window bubble'</span>);       </span></span><br><span class="line"><span class="javascript">    &#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>点击 checkbox，没什么大惊小怪的。<br>点击 label，可以看出：处理完了label上的事件，会再触发一次 checkbox 的 click事件。</p>
<ol start="3">
<li>做点笔记<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body style=&quot;height:1000cm; width:250cm;&quot;&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;body style=&quot;height:1000cm; width:250cm;&quot;&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype htmlxxoo&gt;</span><br><span class="line">&lt;body style=&quot;height:1000cm; width:250cm;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>这几种情况下，document.documentElement.clientHeight 值是不一样的, document.documentElement.clientWidth 却是一样的。我只是想拿到 viewport 的值。我自己的感觉不知道说啥了。这都啥和啥啊？</p>
<p>备忘：<br>screen.width 在 FF 和 Chrome 指的就不一样；缩放一下页面，就看出来了。</p>
<p>不要提物理像素点了。 操作系统的 <strong>分辨率</strong> 也是一层抽象，应用程序就当是 OS 给你提供的 <em>物理像素</em>数据 吧。 还有css单位啥的。将这些东西都放在不同的坐标空间中，关系一目了然。莫再被 devicePixelRatio 等概念糊弄了。莫再提，莫再讲。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2019/01/17/checkbox-notes/" data-id="cjrbs3fhz0006ycv93cmh4ex6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/events/">events</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-funargs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/07/funargs/" class="article-date">
  <time datetime="2019-01-07T01:03:59.000Z" itemprop="datePublished">2019-01-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/07/funargs/">funargs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一路走来。很多东西都是随性而写。很多问题，并未能理解的深刻。问题就像递归一下，要解释这个问题，不得不去解释另一个问题；也怪自己不能很合适的抽象。</p>
<p>今天又是一个乱炖。</p>
<h2 id="function-arguments"><a href="#function-arguments" class="headerlink" title="function arguments"></a>function arguments</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">yes</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">no</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">yesno</span>(<span class="params">no, yes</span>)</span>&#123; <span class="keyword">return</span> yes;&#125;</span><br><span class="line"></span><br><span class="line">yesno(yes, no);</span><br></pre></td></tr></table></figure>
<p>函数就是一个值，可以做参数，也可以当返回值。也因此，在JavaScript中，<strong>函数参数</strong>大行其道，尤其是 callback，无处不在。 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"window was clicked!"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>再举一个栗子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job1</span>(<span class="params"></span>) </span>&#123;<span class="built_in">console</span>.log(<span class="string">"job1 !!!"</span>);&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job2</span>(<span class="params"></span>) </span>&#123;<span class="built_in">console</span>.log(<span class="string">"job2 !!!"</span>);&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job3</span>(<span class="params"></span>) </span>&#123;<span class="built_in">console</span>.log(<span class="string">"job3 !!!"</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jobs</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"jobs ..."</span>);	</span><br><span class="line">	cb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jobs(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">	job1();</span><br><span class="line">	jobs(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		job2();</span><br><span class="line">		jobs(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			job3();</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我也不知道为啥举了这个栗子，哎。人家都说回调多了，就进了地狱，我就是尝试一下地狱。</p>
<h2 id="复制粘贴大法好"><a href="#复制粘贴大法好" class="headerlink" title="复制粘贴大法好"></a>复制粘贴大法好</h2><p><a href="https://developer.mozilla.org/en-US/docs/Glossary/Callback_function" target="_blank" rel="noopener">Callback function</a> A callback function is a function passed into another function as an argument, which is then invoked inside the outer function to complete some kind of routine or action.</p>
<h3 id="粘贴一些小的知识点"><a href="#粘贴一些小的知识点" class="headerlink" title="粘贴一些小的知识点"></a>粘贴一些小的知识点</h3><p>打开 谷歌浏览器的 console。我们来看点东西。我这里是<strong>一句一句执行</strong>的。 </p>
<img src="/2019/01/07/funargs/haha1.png" title="haha1">
<p>没毛病。haha的 Scopes 只有 Global，我这里没有定义 t。</p>
<img src="/2019/01/07/funargs/haha2.png" title="haha2">
<p>擦！haha的 Scopes 变了，[Script, Global]。这就是 let 搞得鬼。let 偷偷修改了作用域。（const 同理）</p>
<img src="/2019/01/07/funargs/haha3.png" title="haha3">
<p>这也就是为什么 t 有值，但是在 this 中找不到！！！</p>
<p>上面说了 let 偷偷修改了作用域，不仅仅是新建作用域这么简单<br><img src="/2019/01/07/funargs/haha4.png" title="haha4"></p>
<p>下图中，Scopes 多了 Block。第一个函数是被优化了，两个其实应该是一样的。作用域链上没用到的，谷歌浏览器直接踢了。<br><img src="/2019/01/07/funargs/haha5.png" title="haha5"></p>
<p>为毛一个多了 Script，一个多了 Block；简而言之，一个是修改，一个是新建（未来会不会有什么变化，到时再看）。这里没有谈及其他的特性，Scoping，TDZ，redeclaration。你以为新语法只有好处拿？？？不得不说，带来了不少新的问题。有空再搞一搞吧。请访问化学家兼计算机科学家的<a href="https://www.web-tinker.com/article/21348.html" target="_blank" rel="noopener">const 和 let 到底定义到哪儿去了？</a><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> t = <span class="string">"go"</span>;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">ttt</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> t;&#125;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.dir(ttt);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">let</span> t = <span class="string">"go"</span>;</span></span><br><span class="line"><span class="javascript">	<span class="function"><span class="keyword">function</span> <span class="title">ttt</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> t;&#125;</span></span><br><span class="line"><span class="javascript">	<span class="built_in">console</span>.dir(ttt);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>JS代码所处的环境就像这样 <code>Global.cpp_initialize(/** **/)</code>，这一句是外界（浏览器？ JSVM？对不起，我不知道）提供，换句话说，我们的这些代码也处在一个外界提供的作用域；由外界提供 this，浏览器中就是 window。</p>
</blockquote>
<p>我以前说过 <strong>this</strong> is not important ，是想说，很多时候你就不必关心 this 。arrow functions 还想探究一下；还是算了，扯着扯着就扯到蛋了，越来越远。感觉又挖坑了！我今天是来搞 function 的，callback 的。打算改写下 callback 的样子。</p>
<h2 id="从网上搜了不少文章，谢谢各位前辈，写下自己的理解。"><a href="#从网上搜了不少文章，谢谢各位前辈，写下自己的理解。" class="headerlink" title="从网上搜了不少文章，谢谢各位前辈，写下自己的理解。"></a>从网上搜了不少文章，谢谢各位前辈，写下自己的理解。</h2><p>(写代码好吃力，各种错误；去网上粘点吧)</p>
<p>这里，我先发送一个请求，完了再发送第二个请求。（辣鸡代码，未处理异常，慎重！）</p>
<ol>
<li>callback<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url1 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"><span class="keyword">var</span> url2 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">url, f</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">	xhr.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">		f(xhr.response);</span><br><span class="line">	&#125;);</span><br><span class="line">	xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">	xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">	xhr.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request(url1, <span class="function"><span class="keyword">function</span> <span class="title">cb1</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"1st: %o"</span>, r);</span><br><span class="line">	request(url2, <span class="function"><span class="keyword">function</span> <span class="title">cb2</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"2nd: %o"</span>, r);</span><br><span class="line">		<span class="comment">// request(url3, function cb3() &#123;&#125;);</span></span><br><span class="line">	&#125;);	</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果想依次发多个请求，把自己就回调进去了，真是焦头烂额。</p>
<ol start="2">
<li>promise<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url1 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"><span class="keyword">const</span> url2 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestP</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">s, f</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">		xhr.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">			s(xhr.response);</span><br><span class="line">		&#125;);		</span><br><span class="line">		xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">		xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">		xhr.send();</span><br><span class="line">	&#125;);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestP(url1)</span><br><span class="line">	.then(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"1st: %o"</span>, v); </span><br><span class="line">		<span class="keyword">return</span> requestP(url2);</span><br><span class="line">	&#125;)</span><br><span class="line">	.then(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"2nd: %o"</span>, v)</span><br><span class="line">		<span class="comment">// return requestP(url3);</span></span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>这样就把 回调 放在 then 里面了。 // 看了一眼别人的代码，哦，懂了。自己写起来，半天挤不出来。唉……</p>
<ol start="3">
<li>generator<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url1 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"><span class="keyword">const</span> url2 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestN</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">	xhr.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">		<span class="comment">//console.log(xhr.response);</span></span><br><span class="line">		rg.next(xhr.response);<span class="comment">/*我们再次启动 rg，并把结果塞回去*/</span></span><br><span class="line">	&#125;);</span><br><span class="line">	xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">	xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">	xhr.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">requestG</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> r1 = <span class="keyword">yield</span> requestN(url1);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"1st: %o"</span>, r1);</span><br><span class="line">	<span class="keyword">let</span> r2 = <span class="keyword">yield</span> requestN(url2);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"2nd: %o"</span>, r2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	let r3 = yield requestN(url3);</span></span><br><span class="line"><span class="comment">	console.log("3rd: %o", r3);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rg = requestG();</span><br><span class="line">rg.next(); <span class="comment">// 启动</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>rg 执行到了 yield 那里，就会计算后面的表达式，然后吐出一个这样的对象 <code>{value: 值, done: false}</code>，rg 就休息了（我也感觉困了）；当 xhr load 以后，执行语句 rg.next(xhr.response)，就会再次唤醒 rg ，并且 yield 返回值就是此时传进去的参数，也就是说把 xhr.response 给了 r1；下次遇到 yield ，rg 又歇菜了。 （至于 rg.throw，rg.return 是干嘛的，我还没用过呢。）</p>
<p>简单说，yield 先要吐出来一个值；再次使用 next 启动时，yield 还要返回一个值，这货还脚踩两只船。吐出来的值（吐一个promise也行，吐一个函数也行），我们这里没用到；我们这里就只利用了 yield 返回值，也就是我们再次启动时，传进去的值，这样才能把结果给 r1、r2。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url1 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"><span class="keyword">const</span> url2 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestP</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">s, f</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">		xhr.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">			s(xhr.response);</span><br><span class="line">		&#125;);		</span><br><span class="line">		xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">		xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">		xhr.send();</span><br><span class="line">	&#125;);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">requestG</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> r1 = <span class="keyword">yield</span> requestP(url1);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"1st: %o"</span>, r1);</span><br><span class="line">	<span class="keyword">let</span> r2 = <span class="keyword">yield</span> requestP(url2);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"2nd: %o"</span>, r2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	let r3 = yield requestP(url3);</span></span><br><span class="line"><span class="comment">	console.log("3rd: %o", r3);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rg = requestG();</span><br><span class="line"><span class="keyword">let</span> p = rg.next(); <span class="comment">// 启动</span></span><br><span class="line"></span><br><span class="line">p.value <span class="comment">// p 是 yield 吐出来的 &#123;value: promise, done: false&#125;，我们取 promise。</span></span><br><span class="line">	.then(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"give result to r1"</span>);</span><br><span class="line">		<span class="keyword">let</span> p = rg.next(v);</span><br><span class="line">		<span class="keyword">return</span> p.value;</span><br><span class="line">	&#125;)</span><br><span class="line">	.then(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">"give result to r2"</span>);</span><br><span class="line">		<span class="keyword">let</span> p = rg.next(v);</span><br><span class="line">		<span class="keyword">return</span> p.value;</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>
<p>代码写的虽然和狗屎一样，但是这次 yield 吐出了一个 promise 的值，（上此吐出来的值，我们并未在意）。我们在 then 中 调用了 next 方法，再次启动 generator，启动的时机不同。</p>
<ol start="4">
<li>async/await<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url1 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"><span class="keyword">const</span> url2 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestP</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">s, f</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">		xhr.addEventListener(<span class="string">'load'</span>, () =&gt; &#123;</span><br><span class="line">			s(xhr.response);</span><br><span class="line">		&#125;);		</span><br><span class="line">		xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">		xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">		xhr.send();</span><br><span class="line">	&#125;);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">requestA</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> r1 = <span class="keyword">await</span> requestP(url1);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"1st: %o"</span>, r1);</span><br><span class="line">	<span class="keyword">let</span> r2 = <span class="keyword">await</span> requestP(url2);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"2nd: %o"</span>, r2);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	let r3 = await requestP(url3);</span></span><br><span class="line"><span class="comment">	console.log("3rd: %o", r3);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestA();</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>await 和 yield 很像，不过更过分。 await “等到”了完成了的 Promise，就会再次启动，并把值返回。</p>
<p>这四个功能基本相同，但写法却有很大不同，主要是越来越简洁清晰，爽快。</p>
<h2 id="yield；-next"><a href="#yield；-next" class="headerlink" title="yield； next"></a>yield； next</h2><p>看看它们的嘴脸。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="built_in">Function</span>; <span class="comment">// Don't worry, be happy!</span></span><br><span class="line"><span class="built_in">Function</span> = <span class="built_in">Object</span>.getPrototypeOf(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;).constructor; <span class="comment">//这些内置对象，不在三界五行之中。你看它的“定义域”就知道了。</span></span><br><span class="line">GeneratorFunction = <span class="built_in">Object</span>.getPrototypeOf(<span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;&#125;).constructor;</span><br><span class="line">AsyncFunction = <span class="built_in">Object</span>.getPrototypeOf(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;).constructor;</span><br><span class="line">AsyncGeneratorFunction = <span class="built_in">Object</span>.getPrototypeOf(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;&#125;).constructor;</span><br></pre></td></tr></table></figure></p>
<p>关于generator的自动执行。 yield 吐出来的那个值，在这个值完成了相关任务后，调用 next(result) 再返回结果。具体参考 <strong>co</strong> 库（听别人说的）。如今还是连字符串操作都不熟练，没心思吹了，打基础去了。</p>
<p>突然想到了这几个 request 函数，比如第一个。request执行了，内部 xhr 去哪里了？虽然上面挂着 load 事件。惊出了我一身冷汗，我再仔细想想。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">url, f</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">	xhr.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123; <span class="comment">// 这个函数定义时候，引用了 xhr。 内存是否会泄露？</span></span><br><span class="line">		f(xhr.response);</span><br><span class="line">		xhr = <span class="literal">null</span>; <span class="comment">// 这样是否会好点？</span></span><br><span class="line">	&#125;);</span><br><span class="line">	xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">	xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">	xhr.send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成天就知道玩弄概念。还是该多练。熟能生巧。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">10000</span>; i++) &#123;</span><br><span class="line">	setTimeout(<span class="function"><span class="params">v</span>=&gt;</span><span class="built_in">console</span>.log(i),); <span class="comment">// v没啥用，我就是不想打那俩个括号</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url1 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"><span class="keyword">var</span> url2 = <span class="string">"https://yesno.wtf/api"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span>(<span class="params">url, f</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();	</span><br><span class="line">	xhr.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">		f(xhr.response);</span><br><span class="line">	&#125;);</span><br><span class="line">	xhr.responseType = <span class="string">"json"</span>;</span><br><span class="line">	xhr.open(<span class="string">'get'</span>, url);</span><br><span class="line">	xhr.send();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request(url1, <span class="function"><span class="keyword">function</span> <span class="title">cb1</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.warn(<span class="string">"1st: %o"</span>, r);</span><br><span class="line">	request(url2, <span class="function"><span class="keyword">function</span> <span class="title">cb2</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.warn(<span class="string">"2nd: %o"</span>, r);</span><br><span class="line">		<span class="comment">// request(url3, function cb3() &#123;&#125;);</span></span><br><span class="line">	&#125;);	</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>先放一万个事件到队列。看结果，xhr 是在半路输出的，插队了。 xhr 很及时，也可能和 timeout 不在一个队列。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2019/01/07/funargs/" data-id="cjrbs3fjf0015ycv9gebbp5ht" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-key-key" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/03/key-key/" class="article-date">
  <time datetime="2019-01-03T02:25:58.000Z" itemprop="datePublished">2019-01-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/03/key-key/">key? key!</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>偷偷摸摸看了阮一峰的<a href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html" target="_blank" rel="noopener">数字签名是什么？</a>，评论也都很精彩。小弟也来凑凑热闹，蹭蹭热度。说一下自己的理解，各位尽情可喷。</p>
<p>心中纵有千般疑问，也只能埋在心里。（搞不定数学啊！这里不谈数学，数学太他么难了。）</p>
<p>我觉得要一个一个问题来说。</p>
<h2 id="私钥与公钥"><a href="#私钥与公钥" class="headerlink" title="私钥与公钥"></a>私钥与公钥</h2><p>这个我也不懂，我又不懂数学，我只会用程序生成。不过不要紧，只需记得<strong>它俩天生一对</strong>就行了。啥意思？假设有 【私钥A、公钥A】 和 【私钥B、公钥B】，还有一个字节串（文本文件，二进制文件都是字节串），如果我用 <em>私钥A</em> 加密一下，那么就只能用 <em>公钥A</em> 解密；用 <em>公钥A</em> 加密一下，也只能用 <em>私钥A</em> 解密。不关B什么鸟事。也不知道RSA钥匙空间是个啥情况？我就假设 钥匙对 的唯一性，只有配对才能互解；而这也是为啥可以加密，为啥可以签名的基石。</p>
<p>这里，还有几点说下。</p>
<ul>
<li>什么叫加密，解密？</li>
</ul>
<p>加密就是换了一个形式，解密就是还原。举个栗子，伪代码，<code>RSA_encrypt(bytes, 私钥A) ==&gt; bytes&#39;, RSA_decrypt(bytes&#39;, 公钥A) ==&gt; bytes</code> 。注意，这里加密解密都是用 RSA 相关函数。特别注意 <code>RSA_decrypt(bytes&#39;, 公钥B)</code> 会出错（据说是满足不了一个数学条件）。还有，某些人会用 <code>XXX_decrypt(bytes&#39;, 钥匙C) ==&gt; bytes&#39;&#39;</code> 这个嘛，大哥，我们用的是 RSA，你这个 <code>bytes&#39;&#39;</code>还不如我手动打开 <code>bytes&#39;</code> 在后面添加字节 <code>xxoo</code>，就好像是 <code>decrypt(byptes&#39;, &#39;xxoo&#39;) ==&gt; bytes&#39;&#39;&#39;</code>，我这是手动解密啊，哈哈。不知道说清楚没有？就是说我用RSA的算法加密了一个文件，你却用凯撒算法<strong>“解密”</strong>了一个新文件，说：“我解密了”。字节串变换字节串嘛。我上去就是一脚。</p>
<ul>
<li>公私有何区别？</li>
</ul>
<p>私钥与公钥作为天造地设的一对，互相可解。看起来没啥区别啊！假如有一钥匙对，一个拿给你，一个拿给我。你加密，我就能解密；我加密，你也能解密。这不是公私不分嘛！其实这个钥匙对中，公私是分明的，你可以自己生成一对，打开看看它们的文本表示，私钥长得多，还可对私钥设置口令。有一个细节是，私钥与公钥加密、解密所用的函数都是不同的，大概 <code>RSA_public_encrypt, RSA_private_decrypt； RSA_private_encrypt, RSA_public_decrypt</code> （上一条的伪代码还是有些瑕疵。）所以，你要是把 私钥 当 公钥 分发出去，自己却留着 公钥 当 私钥，那么就会错误百出。只是，仅仅谈 加解密 这点，公私作用是一样的。</p>
<ul>
<li>丢了怎么办？</li>
</ul>
<p>私钥丢失，比如说你唯一的电脑被儿子弄坏，修不好。恭喜你，你肯定有老婆了。只好重新生成秘钥对了。谁要是用你以前的公钥给你发密信，告诉他用新的公钥即可。</p>
<h2 id="上面扯了这么久，下面我们来谈正事。"><a href="#上面扯了这么久，下面我们来谈正事。" class="headerlink" title="上面扯了这么久，下面我们来谈正事。"></a>上面扯了这么久，下面我们来谈正事。</h2><p>原本打算搞几张图片，活跃一下气氛，表达更形象。不会弄。算了。写到这，才发现，这个话题太大了，我根本驾驭不了。只能简化了。</p>
<ul>
<li><p>加密，我要给老王的老婆发消息，怕别人知道，就用老王的老婆的公钥加密一下，别人拿到也没用，老王的老婆拿到后，用她自己的私钥解密就行了。由此，可以看到，我想发密信给谁，用他的公钥加密后，再发，就比较放心了。</p>
</li>
<li><p>签名，我先用老王的老婆的公钥把消息加密，然后我再用我的私钥加密一次。其他人拿到后，只能用我的公钥解开，大家一看，“哦，这是小李发出来的”，但是看不到我的原文；老王的老婆用我的公钥解密了，心里乐开了花，的确是小李发的，然后用她的私钥再解一次，就能看到内容了。或者，我先用我的私钥加密一次，再用老王的老婆的公钥加密一次，发出去。别人打不开，老王的老婆用私钥解密，再用我的公钥解密，“哦，是小李发来的”。在这里，我的私钥作用就是签名，确实是我（即使不是我，也是我的那个私钥）发出来的消息。实际不是这么用的，一般都是签在摘要上面。</p>
</li>
<li><p>完整性，这里也提一提，毕竟还是容易混淆。想象这样一个场景，我发了 [str, hash(str)]，你收到了，然后自己对str进行了hash，发现没错，那么str就是完整的；即使哪个2B截获了，改成[str’, hash(str’)]，再发给你，你收到了，然后自己对str’进行了hash，还是没错，那么str’就是完整的。哈哈，这就是完整性。但是，情况不是这样的，坏就坏在，我像个傻逼一样，不该把 hash值发给你。我就发个 str给你，你算完hash，打电话（假定电话安全）和我核对一下。这里你可能要问，为啥不加密？因为我仅仅想说一下完整性这个概念，不想谈及安全。就比如，你昨天写了点字符串，你就可以算一个hash值，记在纸上；今天你想看看是不是完整的，有没有被改动，就再对它hash一下，和昨天的纸上记载的对比一下。当在网络上传输的时候，情况就开始复杂了。完整性本来是需要保存正本，然后副本来和正本一一对比；不过那样代价太大了，而hash，比如sha1提供了足够的可靠性，并且效率高啊，所以就用hash值来比较。</p>
</li>
</ul>
<p>可以完全不提人，就画很多的钥匙对，概念可能更准确。但是实际钥匙都是个人或者机构持有的，所以就说成了谁的私钥，谁的公钥。比如 私钥<sub>小明</sub> 和 公钥<sub>小明</sub> 是一对的，如果某天 私钥<sub>小明</sub> 落入到了 大锤 手里，大家可能还不知道。 钥匙确实是配对的，但所属变了。对于签名来说，用 公钥<sub>小明</sub>，解开的一定是 私钥<sub>小明</sub>，我们就认为这个是消息是小明的，没想到却是大锤发的。严谨来说，我们可以说这个消息是 私钥<sub>小明</sub> 持有者发的。不客气的说，公钥<sub>小明</sub> 解开的，就是 私钥<sub>小明</sub> 签名的。具体谁人做的，无法保证，但一般就认为是小明，不排除小明给她老婆共享了 私钥<sub>小明</sub>。</p>
<p>上面简介了三个概念，不过都很理想；当进入到现实的时候，很多问题就要考虑了。首要考虑安全，安全第一嘛！私钥的安全就要靠你自己了。别人要是把刀驾到你的脖子上，那也保不住了。我们只考虑公钥的安全。</p>
<h2 id="理想与现实"><a href="#理想与现实" class="headerlink" title="理想与现实"></a>理想与现实</h2><p>我们也只考虑网络传输（你驱车万里送一个文件，或者通过安全电话一个字节一个字节口读1G的文件给对方，也当我啥也没说）。</p>
<p>我们假设老王是不敢威胁他老婆的，她老婆的私钥是安全的，只有她自己持有。也就是假设每个人的私钥是安全的（如果你被控制人身自由，电脑被控制，身不由己，就当我啥也没说，你也别往下看了；凡事都要满足一定的条件才能成立）。</p>
<p>（TMD，编不下去了）</p>
<p>你拿到了C的公钥，那就一定是C的公钥吗？</p>
<h1 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2019/01/03/key-key/" data-id="cjrbs3fij000fycv9ry0ks3vo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cryptography/">cryptography</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nginx-proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/28/nginx-proxy/" class="article-date">
  <time datetime="2018-12-28T06:26:06.000Z" itemprop="datePublished">2018-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/28/nginx-proxy/">nginx proxy</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天玩弄 aliyun ECS 的时候，在远程机上抄了一个 koa 的例子，哈哈，太不专业了。却不知道如何跑起来。就在网上乱搜一通。简单了解了下nginx 代理，下面谈点我的理解，仅仅是自己思考，没什么全面性和系统性。</p>
<h1 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h1><p>网上的例子。 就拿web访问来说，上谷歌上不去，弄个代理；有时候想隐藏自己的ip，弄个代理。</p>
<p>大概就是 <strong>client</strong> <-> <strong>proxy</strong> <-> <strong>server</strong>，（不管什么路由器，经过了多少网络节点……，只考虑这个三节点）。单看正向代理，第一是关于 <strong>client</strong> 的事情，不管它能不能直接访问 <strong>server</strong>，它都可以选择使用 <strong>proxy</strong>，比如上谷歌，能不能直连，不影响你是否能使用 <strong>proxy</strong>，或许你仅仅是想隐藏什么。第二关于 <strong>proxy</strong> ，它的确需要两头都能连通，它要提供功能，当 <strong>client</strong> 使用了它的时候，发出一个对 <strong>server</strong> 的请求，这时候你使用的 <strong>proxy</strong> 就接管了这个请求；至于是否隐藏 <strong>client</strong> 的IP等信息，就看 <strong>proxy</strong> 是如何实现的，它是可以把 <strong>client</strong> 的IP信息发给 <strong>server</strong> 的。整个流程看起来就是 <strong>client</strong> 访问了 <strong>server</strong>。然而，实际，<strong>client</strong> 只是访问了 <strong>proxy</strong> 而已；或者 <strong>client</strong> 对 <strong>proxy</strong> 说，请帮我访问下 <strong>server</strong>。</-></-></p>
<p>再说一句，连不上谷歌，使用代理服务器，只是正向代理的一个场景。而能连上谷歌，你也可以使用代理服务器，因为你可能想做些私人的事。<strong>client</strong> 在某种程度上糊弄了 <strong>server</strong>。</p>
<h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><p>比如我访问 <a href="https://www.aliyun.com/xx" target="_blank" rel="noopener">https://www.aliyun.com/xx</a> 和 <a href="https://www.aliyun.com/oo" target="_blank" rel="noopener">https://www.aliyun.com/oo</a> （本故事纯属虚构，如有雷同，纯属巧合！）。我本以为是这样的 <strong>C</strong> <-> <strong>S</strong>。但是实际情况可能是 <strong>C</strong> <-> <strong>P</strong> <-> <strong>S1(xx)</strong>， <strong>C</strong> <-> <strong>P</strong> <-> <strong>S2(oo)</strong> 。其实我访问的是 <strong>P</strong>，它把不同种类的请求分发给了后面不同的服务器。在 <strong>C</strong> <-> <strong>P</strong> 中, 这个 <strong>P</strong> 作为一个反向代理，糊弄了 <strong>C</strong> ，让整个流程变成 <strong>C</strong> <-> <strong>P</strong> <--><strong>Ss</strong>。单看反向代理，就是 <strong>P</strong> 的事情，它会把请求分发到一堆 <strong>Ss</strong>；而 <strong>C</strong> 是不知道的，除非 <strong>P</strong> 愿意泄露点啥。</--></-></-></-></-></-></-></-></p>
<h1 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h1><p>然后就变成了 <strong>C</strong> <-> <strong>P<sub>forward</sub></strong> <-> <strong>P<sub>reverse</sub></strong> <-> <strong>Ss</strong>。 <strong>C</strong> 通过 <strong>P<sub>forward</sub></strong> 糊弄 <strong>P<sub>reverse</sub></strong> ，<strong>P<sub>reverse</sub></strong> 用了一堆 <strong>Ss</strong> 反过来也在糊弄 <strong>P<sub>forward</sub></strong>。 <strong>C</strong> 通过 <strong>P<sub>forward</sub></strong> 以为自己访问了 <strong>P<sub>reverse</sub></strong>，实际 <strong>P<sub>reverse</sub></strong> 却把请求给了 <strong>Ss</strong>。</-></-></-></p>
<h1 id="悲伤"><a href="#悲伤" class="headerlink" title="悲伤"></a>悲伤</h1><p>总想表达更清楚点，奈何几乎能<em>一年无话</em>，撞了南墙也不回头。写东西也是把自己绕进去。</p>
<h1 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h1><p>我在 aliyun ECS，开了 nginx 监听 80 端口，其中 location /hw { proxy_pass <a href="http://127.0.0.1/3456" target="_blank" rel="noopener">http://127.0.0.1/3456</a>; } ，location /danteng { proxy_pass <a href="http://127.0.0.1/6543" target="_blank" rel="noopener">http://127.0.0.1/6543</a>; } ；开了两个 node 应用，一个监听 3456，一个监听 6543。然后 访问 */hw 和 */danteng，就访问了不同的应用，也就是服务吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2018/12/28/nginx-proxy/" data-id="cjrbs3fil000hycv9p3zgesan" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/server/">server</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-notes-on-async-await" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/24/notes-on-async-await/" class="article-date">
  <time datetime="2018-12-24T03:06:57.000Z" itemprop="datePublished">2018-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/24/notes-on-async-await/">notes on async/await</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>大家好，又到了新一期“扯蛋”时间了。</p>
<p>我几乎没怎么用过 <code>callbacks</code>，<code>promise</code>，<code>generator</code>，<code>yield</code> 这些听起来牛逼哄哄的东西。我直接来看 <code>async/await</code>。有这么多前辈高人，我这小菜就捡了便宜，越过了这一系列发展过程中的酸甜苦辣，直接去偷取“果实”。还有我看<em>CSS</em>的时候，是无视了<strong>IE6</strong>这个可怕时代，直接看<em>CSS3</em>的知识。这也就是大家所说的<strong>速成</strong>，没什么内力，没经历过，就不明白现在为啥是这个样子，不扯了，去吃完<em>扯面</em>再说。</p>
<p>我先是看了<strong>边城</strong>的<a href="https://segmentfault.com/a/1190000007535316" target="_blank" rel="noopener">理解 JavaScript 的 async/await</a>，受益匪浅；接着又找到了<strong>allen_he</strong>的<a href="https://segmentfault.com/a/1190000011296839" target="_blank" rel="noopener">async/await 执行顺序详解</a>，这篇文章就是我想要的，看下面的评论，不管测试结果，我要的就是这篇的解释和这个思路。我瞅了一眼<strong>阮一峰</strong>的<a href="http://www.ruanyifeng.com/blog/2018/02/node-event-loop.html" target="_blank" rel="noopener">Node 定时器详解</a>，这和浏览器中的Event loop还是有很多不同之处，尤其每一轮事件循环中要干的活是大大的不同。</p>
<p>此篇仅仅是一个开始，还需投入精力加深理解。</p>
<ol>
<li>让我们测试几个代码，<strong>学习研究之用</strong>。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"script start..."</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">"next loop, obviously!"</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ss</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"I'm ss"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"ss"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"test start..."</span>);</span><br><span class="line">	<span class="keyword">const</span> r = <span class="keyword">await</span> ss();</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`r: <span class="subst">$&#123;r&#125;</span>`</span>);	</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"test end..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test();</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'how to put a promise to the microtask queue?'</span>).then(<span class="built_in">console</span>.log, <span class="built_in">console</span>.error);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"script end..."</span>);</span><br></pre></td></tr></table></figure>
<p>结果在此，请不要偷看，O(∩_∩)O</p>
<blockquote>
<p>script start…<br>test start…<br>I’m ss<br>script end…<br>r: ss<br>test end…<br>how to put a promise to the microtask queue?<br>next loop, obviously!</p>
</blockquote>
<ol start="2">
<li>略微改动。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"script start..."</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span>=&gt;</span><span class="built_in">console</span>.log(<span class="string">"next loop, obviously!"</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">ss</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"I'm ss"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"ss"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"test start..."</span>);</span><br><span class="line">	<span class="keyword">const</span> r = <span class="keyword">await</span> ss();</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`r: <span class="subst">$&#123;r&#125;</span>`</span>);	</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"test end..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test();</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'how to put a promise to the microtask queue?'</span>).then(<span class="built_in">console</span>.log, <span class="built_in">console</span>.error);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"script end..."</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>script start…<br>test start…<br>I’m ss<br>script end…<br>how to put a promise to the microtask queue?<br>r: ss<br>test end…<br>next loop, obviously!</p>
</blockquote>
<h2 id="分析一下"><a href="#分析一下" class="headerlink" title="分析一下"></a>分析一下</h2><p>这两段代码几乎一毛一样。仅仅是 await 那里，第一次等了个 Function call，第二次等了 AsyncFunction call。说白了，第一次等待返回的不是Promise的值 “ss”；第二次等待返回的是一个Promise的值 #value:”ss”, status:”resolved”#。（这里用词不是很准确，比如 Promise的值，你懂得就好。至于第二个值，只是意思意思表示一下，大概就那样子，没有字面量表示法。）</p>
<p>这个 await 还是很骚的。</p>
<ul>
<li><p>第一次，哎呀，是个字符串，不是Promise的值，舍不得交出去，等等吧。跳出了test的执行（注意是跳出去了，暂停了，执行的现场还是保存了）。执行完后面的几句代码，然后搂不住了，await 只好把东西交出来，也就是继续执行。完事，没码可执行，就把 microtask queue 清空了。最后到下一轮task了。</p>
</li>
<li><p>第二次，这货更加过分，因为是个Promise，这货就是不肯交出来。直到 microtask queue 清空了，才知道大势已去，也只能返回这个Promise的值，赶紧执行剩余代码。新的一轮工作又开始了。</p>
</li>
</ul>
<p>简单说就是在 AsyncFunction call 中 await expression, expression的值算出来以后（这里也很讲究，expression的计算，如果放在主线程，还是要卡住，像ajax比较适合，反正不在主线程计算，马上能返回，最后给个结果就行），await 拿到值，现在是不会交出来的；<br>而且还要对别人说：“滚，离我远点。”，没办法，只能暂时跳出这个 AsyncFunction 了。执行后面的代码。完事后，这里也是一个关键点。如果 await 拿的不是一个 Promise的值，那它就要交出来，AsynFunction call得以继续执行，接着清 microtask queue；但如果 await 手里拿的是一个 Promise的值，不管是pending状态还是完蛋状态，都会先清 mircotask queue，它会死皮赖脸的，要等 Promise 计算完后（非pending状态） ，才肯交出那个值，继续从暂停的地方执行。 </p>
<p>当然，这个流程不是 await 控制的，只是把 await 拿到第一人称比较形象。这货就是个拖啊，先拖住再说。 await expression，expression计算出来以后，会有一跳，这就改变了代码的执行流程；待后来，它王者归来，返回胜利的果实。所以，它有自己的适用范围。你确实什么都可以给它 await 一下，但你从这个执行流程也可以看出来，你 await 的任务，如果要在主线程执行，也是没啥卵用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">**含有伪代码，慎重</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">jobs();<span class="comment">//简单任务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">B2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> p = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span>=&gt;</span>&#123;</span><br><span class="line">		sleep(一天);</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">			sleep(一天);</span><br><span class="line">			r(<span class="string">"呵呵"</span>)</span><br><span class="line">		&#125;,一天)；</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">"p: "</span> +p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">B2();</span><br><span class="line"></span><br><span class="line">Steve_Jobs();<span class="comment">//复杂计算</span></span><br><span class="line"><span class="comment">/**/</span></span><br></pre></td></tr></table></figure>
<p>看吧，await 后面的先要睡一天，setTimout就几毫秒吧（我机子，<code>console.time(&#39;sT&#39;);setTimeout(function(){},1000);console.timeEnd(&#39;sT&#39;);</code>，cpu G3220，Chrome71 0.05 ~ 0.13 ms, node v10.4.0 0.06 ~ 0.95 ms，交互式不超过0.1ms，文件式就比较耗时，但也没有超过1ms；仅做参考，机器及环境相关），await拿到Promise（是pending状态）。出去算完 Steve_Jobs。 一天后，setTimeout任务来了，可是它又睡了一天，然后 Promise 就resolved了。此时 p 值才得以打印。流程就是这样。或许浏览器会直接让你滚蛋，他么的什么破代码，想卡死我？。nodejs上我也没有试过。</p>
<p>当然，小弟的栗子不好吃，不太恰当。</p>
<p><em>在下</em>在上篇文章中，也说了，不爱提什么同步异步的。如下片段，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r1 = <span class="keyword">await</span> job1();</span><br><span class="line">r2 = <span class="keyword">await</span> job2(r1);</span><br><span class="line">r3 = <span class="keyword">await</span> job3(r2, r1);</span><br></pre></td></tr></table></figure>
<p>异不异步我不管，你口中的异步任务，还是按次序来。重要的是次序。</p>
<p>不过，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> r = <span class="keyword">await</span> ajax(some-url); </span><br><span class="line">callback(r);</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></p>
<p>确实比<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ajax(some-url, callback);</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></p>
<p>看起来舒服多了。尤其是你安排很多后续任务，才会有真正的优势。本篇的重点是刻画一下 await 这个货。具体怎么使用，我也不会。拜拜，我们下期再见。</p>
<h1 id="刚才又想了想，有些地方不对"><a href="#刚才又想了想，有些地方不对" class="headerlink" title="刚才又想了想，有些地方不对"></a>刚才又想了想，有些地方不对</h1><p>上面吹了那么多牛，后来，我发现，自己不能解释下面的代码，次序都是 step1-&gt;step2-&gt;step3；可是两段代码的互相穿插，穿插的顺序呢？ await 到底和 then 之间有着怎样的爱恨情仇？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">takeLongtime</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">		setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(n + <span class="number">200</span>), n);</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step1</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`step1: <span class="subst">$&#123;n&#125;</span>`</span>);</span><br><span class="line">	<span class="keyword">return</span> takeLongtime(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step2</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`step2: <span class="subst">$&#123;n&#125;</span>`</span>);</span><br><span class="line">	<span class="keyword">return</span> takeLongtime(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">step3</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`step3: <span class="subst">$&#123;n&#125;</span>`</span>);</span><br><span class="line">	<span class="keyword">return</span> takeLongtime(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'sT1'</span>);</span><br><span class="line">step1(<span class="number">400</span>)</span><br><span class="line">	.then(step2)</span><br><span class="line">	.then(step3)</span><br><span class="line">	.then(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(v);</span><br><span class="line">		<span class="built_in">console</span>.timeEnd(<span class="string">'sT1'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">af</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.time(<span class="string">'sT2'</span>);</span><br><span class="line">	<span class="keyword">const</span> n = <span class="number">400</span>;</span><br><span class="line">	<span class="keyword">const</span> r1 = <span class="keyword">await</span> step1(n);</span><br><span class="line">	<span class="keyword">const</span> r2 = <span class="keyword">await</span> step2(r1);</span><br><span class="line">	<span class="keyword">const</span> r3 = <span class="keyword">await</span> step3(r2);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`r3: <span class="subst">$&#123;r3&#125;</span>`</span>);</span><br><span class="line">	<span class="built_in">console</span>.timeEnd(<span class="string">'sT2'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">af();</span><br></pre></td></tr></table></figure>
<p>这里我搞不清的是下面的问题：</p>
<ol>
<li><code>function cb(n) {}; setTimeout(cb, 5000, 1234);</code>，当setTimeout执行了，那么可以认为Timer线程在五秒后会把 <em>cb</em> 及其参数 <em>1234</em> 打入冷宫，不，打入事件队列。主线程有空就执行一下。</li>
<li>那么<br><code>new Promise(r=&gt;{
 setTimeout(()=&gt;r(&quot;呵呵&quot;), 5000)
}).then(console.log, console.error);</code>，它是如何执行的？</li>
</ol>
<ul>
<li>new Promise，首先setTimeout执行了，返回一个 <strong>pending</strong> 状态的 Promise 对象。（五秒后Timer线程会放 <code>()=&gt;r(&#39;呵呵&#39;)</code> 进入事件队列；当主线程执行了这个，Promise对象就会<strong>resolved</strong>，值就是 “呵呵”。）</li>
<li>我想问的是，new Promise这个构造执行完，返回 <strong>pending</strong> 状态的 Promise 对象，然后呢？然后干什么？（离开这里，往下执行？将来再回来？）那后面的then也不能不管吧？既然是 <strong>pending</strong>，那也不能把后面 then 中的两个任务某一个放入 microtask queue 吧？应该是其他线程接管了。这个先放一放。</li>
</ul>
<h1 id="我又来装逼了"><a href="#我又来装逼了" class="headerlink" title="我又来装逼了"></a>我又来装逼了</h1><p><a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="noopener">老阮的文章</a>，其中还有<strong>朴灵</strong>的批注。啥也不说，看了看评论。只是觉得太浮躁了。细思极恐。披着各种外衣的。打着追求真理的幌子。所谓的概念不是自己的理解吗？不断提升吗？就一下子想得到正确的概念，正确的答案？真能一下子得到<em>正确</em>的概念，这个世界就简单了，还要学习吗？或者，哪有什么真理，你真的想过？写操作系统，写v8的那些人，代码还在不断更新，为啥不是一出来就是完美的？哪些可是真的大神啊。在哥德尔手里，数字能推翻公理化；在我手里也只能加加减减卡里剰几毛钱了。什么是“横看成岭侧成峰”，成天背几个概念，顶个毛用。线程咋咋，进程咋咋，你知道线程怎么表示？数据结构有多少字段？（sorry，我不知道）背那么清楚还不如踢足球？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.isNaN(<span class="built_in">Object</span>)</span><br><span class="line"><span class="built_in">Number</span>.isNaN(<span class="built_in">Object</span>)</span><br><span class="line"><span class="number">2</span>**<span class="number">53</span> === <span class="number">2</span>**<span class="number">53</span> + <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>talk is cheap，show me the code。哈哈。</p>
<h1 id="书是看不完的，得有自己的理解，思维。偷偷打基础，来日可与群雄一战。技术，知识将来才是真正的战场。"><a href="#书是看不完的，得有自己的理解，思维。偷偷打基础，来日可与群雄一战。技术，知识将来才是真正的战场。" class="headerlink" title="书是看不完的，得有自己的理解，思维。偷偷打基础，来日可与群雄一战。技术，知识将来才是真正的战场。"></a>书是看不完的，得有自己的理解，思维。偷偷打基础，来日可与群雄一战。技术，知识将来才是真正的战场。</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2018/12/24/notes-on-async-await/" data-id="cjrbs3fji0018ycv9173ayal3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-sync-and-async" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/21/sync-and-async/" class="article-date">
  <time datetime="2018-12-21T02:36:14.000Z" itemprop="datePublished">2018-12-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/21/sync-and-async/">sync-and-async</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="同步？异步？"><a href="#同步？异步？" class="headerlink" title="同步？异步？"></a>同步？异步？</h1><p>虽然是个菜，但是我还是有话要说。在学JS，等下就分析几个浏览器中JS代码片段。</p>
<p>同步，异步不知道谁翻译的。我书读的不多。可是觉得滥用了。这两个词，哎。我还是没有想的特别清晰。试着谈谈吧。</p>
<h2 id="还得从其他地方说去，long-long-ago…"><a href="#还得从其他地方说去，long-long-ago…" class="headerlink" title="还得从其他地方说去，long long ago…"></a>还得从其他地方说去，long long ago…</h2><ol>
<li>开始你有两只手，你左手码字，右手撸管。（手就是双核，码字，撸管就是进程啥的，脑子来调度。此操作可以是并行的，互不干扰，不行就让别人帮你。当然你也可以并发，去刷牙…）</li>
<li>后来你觉得没有节奏感，应该码一字，撸一下。此时还是并行，不过同步了一下。（什么同步？谁和谁？）</li>
<li>再后来你不小心被小郭妹子断了右手。</li>
<li>你在想该怎么办？</li>
</ol>
<ul>
<li>你左手码完字，然后左手撸啊撸。（单任务）</li>
<li>你左手码一字，左手又去撸一下。（并发了。不过来回切换上下文，也累啊。）</li>
</ul>
<p>说了半天，什么是同步？异步？第二步提到的同步是啥？因为在第二步中，我们为了追求节奏感，可以认为这两个进程或者操作变成了一个大任务。而同步异步应该说的就是一个大任务中的各个小任务之间的执行顺序。我在人民广场吃炸鸡，你在网吧打游戏，这同不同步，异不异步有何用？除非弄成一个任务的两部分。</p>
<h2 id="这里我们要提到层次结构。因为任务是可以细化的。"><a href="#这里我们要提到层次结构。因为任务是可以细化的。" class="headerlink" title="这里我们要提到层次结构。因为任务是可以细化的。"></a>这里我们要提到层次结构。因为任务是可以细化的。</h2><p>一个进程的生命周期中，每个线程一定是按照一定的次序执行的。不管是挨个执行指令，还是分支，循环，跳转……都是按次序的。虽然线程与线程之间看起来没了先后次序，那每个线程内部还是按次序执行。对这些操作系统理论，不清楚。但我坚信，局部是有次序的，它们一定会遵循一定的原则。一堆进程，看起来，乱乱的，但是每个进程内部都是有严格次序的，不会跑过去执行另一个进程空间的指令。就进程内部来说，一堆线程，乱乱的，可是每个线程也是有自己的次序。<strong>次序永存。</strong></p>
<p>直接上码。无码最可耻。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job1</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="string">"job1"</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job2</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="string">"job2"</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job3</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="string">"job3"</span>;&#125;</span><br><span class="line"></span><br><span class="line">job1();<span class="comment">//1</span></span><br><span class="line">job2();<span class="comment">//2</span></span><br><span class="line">job3();<span class="comment">//3</span></span><br></pre></td></tr></table></figure>
<p>这段代码的执行，有次序，1=&gt;2=&gt;3。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job1</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="string">"job1"</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job2</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="string">"job2"</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job3</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span> <span class="string">"job3"</span>;&#125;</span><br><span class="line"></span><br><span class="line">job1();<span class="comment">//1</span></span><br><span class="line">setTimeout(job2, <span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>);<span class="comment">//2</span></span><br><span class="line">job3();<span class="comment">//3</span></span><br></pre></td></tr></table></figure>
<p>这段代码的执行，有次序，1=&gt;2=&gt;3。 job1执行；然后setTimeout执行，这里发生了一件事，它郑重的把job2和86400000交给了Timer线程，然后立马返回一个timeoutID（定时器编号，可使用clearTimeout清除），不过我们没保存这个值；然后job3执行。对吗？线程内还是按次序执行，一步一步来嘛（同步这个词实在让人困惑）。job1=&gt;setTimeout=&gt;job3，不费吹灰之力。大概在第二天的此刻却发生了一个可怕的事情，job2冒了出来（异步这个词也实在让人困惑）。在我看来他们完全是按照次序，即使你把job2放到事件队列，那还是按次序来，job2它自己内部的代码也是按次序在主线程执行。a=&gt;b=&gt;c是次序, b=&gt;a=&gt;c也是次序。job1，job2，job3每个里面都可以再加任务。</p>
<ol>
<li>就算你把第二句换成 <code>ajax(some-url, job2)</code>，还是job1=&gt;ajax=&gt;job3这个次序，（ajax把some-url, job2交给其他线程，立马返回。那个线程干完活，就把job2加到队列）不知啥时候job2会给你来一下。</li>
<li>如果ajax不是立马返回，（浏览器应该是废弃这种用法了），次序就是job1=&gt;ajax-job2=&gt;job3。(ajax-job2, ajax执行，调用job2，ajax返回)</li>
</ol>
<p>如果不是立马返回，还有啥意思，难道要<code>setTimeout(job2, 24*60*60*1000);</code>一直等？不管在现实生活中还是在计算机系统中，都是不合理的！就是要把job2扔到队列中。他们把这种叫异步编程。如今，你可以想办法把它扔到task queue，或者microtask queue。但是话又说回来，当你明白了次序，你也会明白，啥都往队列中塞，也是不好的做法；举个栗子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job1</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="string">"job1"</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> i=<span class="number">0</span>; </span><br><span class="line">	<span class="keyword">while</span>(i&lt;<span class="built_in">Number</span>.MAX_SAFE_INTEGER)&#123;</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"job2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">job3</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="string">"job3"</span>;&#125;</span><br><span class="line"></span><br><span class="line">job1();<span class="comment">//1</span></span><br><span class="line">setTimeout(job2, <span class="number">1000</span>);<span class="comment">//2</span></span><br><span class="line">job3();<span class="comment">//3</span></span><br></pre></td></tr></table></figure>
<p>你把job2扔到队列中也是没用的。到头来，它还是会回到主线程执行，说不定卡死。这种应该新开个Woker线程。</p>
<h2 id="瞎扯事件"><a href="#瞎扯事件" class="headerlink" title="瞎扯事件"></a>瞎扯事件</h2><p>什么是事件。你对着浏览器大喊，“你个2B”，浏览器显示，“滚蛋”。这就是声音事件和浏览器对事件的处理。可惜的是，浏览器不是你实现的，要是你实现的，你想加什么事件都行，你还可以完全不处理鼠标事件。不过，估计也没有什么人会用你的浏览器了。</p>
<p>浏览器中有很多预定义的事件。你点一下鼠标，按一下键盘，都会出事。浏览器这个应用程序也真是复杂啊，操作系统GUI有一套消息机制，浏览器拿到这些消息，又在内部实现了自己的事件机制。一般的应用程序，处理下操作系统的消息就不错了，像win32中的 WM_QUIT……。Windows中的消息，有的消息是不进队列的，有的消息有时候不进有时候进。那看看浏览器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_2b</span>(<span class="params">z</span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">'2B'</span>);&#125;</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'click'</span>, _2b)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	some jobs</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="built_in">document</span>.body.click();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	some tasks</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>一般用户都是用鼠标点击页面，_2b入队列。 代码中click函数触发，直接调用 _2b，不入队列。</p>
<p>我现在也没想好下面说啥。但我不怎么喜欢在这里用同步、异步。就是Script执行完，掏空microtask，然后UI善后；再拿一个task，完了掏空microtask，UI善后；……</p>
<p>谁和谁同步，谁和谁异步？晕。把job2放到队列叫异步？那拿到job2执行的时候，不就是同步了？同步的任务，里面没有异步代码？异步的任务，里面没有一句同步代码？两个语句什么关系？两个函数什么关系？两个任务什么关系？两个模块什么关系？你把馒头吃到嘴里，再到胃里。若说这两个是同步任务，那吃到嘴里细分，切牙咬和磨牙磨这小任务是什么关系？我觉得不需要这些伪概念。我觉得JS运行时这个层面，没啥同步、异步，只有Event Loop。所有的任务都遵守着看不见的秩序。</p>
<p><em>未完待续</em></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2018/12/21/sync-and-async/" data-id="cjrbs3fjr001gycv95eq5eg1j" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="usage-ssh" class="article article-type-usage" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/21/ssh/" class="article-date">
  <time datetime="2018-12-21T01:17:37.000Z" itemprop="datePublished">2018-12-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/21/ssh/">ssh</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ssh-的一点使用记录"><a href="#ssh-的一点使用记录" class="headerlink" title="ssh 的一点使用记录"></a>ssh 的一点使用记录</h1><p>最近一直玩手游，看小说。估计快<strong>修仙</strong>了。废了。不过也抽空买了个 阿里云ecs，补习JS，准备捣鼓一下。</p>
<h2 id="操作，遂记录如下。"><a href="#操作，遂记录如下。" class="headerlink" title="操作，遂记录如下。"></a>操作，遂记录如下。</h2><ol>
<li>配置不提，系统选的是<em>CentOS</em>。拿到公网IP，（是否通过企业级NAT，管不了那么多了。）能连接就行了。</li>
<li>我怎么弄得root初始密码，也记不清了。哎，拖到今天，不能复现当时情况了。应该是 阿里云的控制台 重置的吧。</li>
</ol>
<ul>
<li>网页也可以登录，从控制台那里找到实例，远程连接。需要输入六位的网页密码，第一次登录会给你。也可以重置，手机验证。然后是网页中的黑屏，输入用户名，密码即可。（似乎在console看到了WebSocket。）</li>
<li>windows下可以用 putty，ssh登录，端口22是默认开启的。如果你当时选系统Windows，可以用远程桌面连接，端口3389默认开启的。</li>
</ul>
<ol start="3">
<li>ssh的密码登录不提，我这里想使用的是 Public Key登录。</li>
</ol>
<ul>
<li>生成秘钥。 安不安全不提，无所谓在哪里生成 秘钥，关键是要拿到自己手里。你可以在自己的机器上生成。我是在密码登录了远程机，然后生成的。<ul>
<li>直接 <code>ssh-keygen</code>，连 -t rsa 都不用。</li>
<li>一路回车，如果你需要给 Private Key 设置密码，你就设置一个记住就行。</li>
<li>完事后就得到 Key Pair（Public Key 和 Private Key），默认就是 .ssh/id_rsa.pub，.ssh/id_rsa 两个文件。 我是在远程机上操作的（不推荐），我把这两文件赶紧弄到我本地机子上藏了起来。</li>
</ul>
</li>
<li>把公钥弄到远程机上。我本来就在远程机上生成的，这一步倒是免了。win7可以用putty带的psftp传。<ul>
<li>在远程机器上，把 id_rsa.pub 放到你的 /home/你的用户名/.ssh文件夹。难道你想放到别人的 .ssh目录中？</li>
<li>然后 把 id_rsa.pub 的内容追加到 authorized_keys 文件中。如果不存在就建立。 <code>touch authorized_keys</code>。操作都在你的 .ssh目录。</li>
<li>可以说就完了。就这么简单。 我然后把id_rsa.pub删除了，这都随你。我也没啥经验。</li>
</ul>
</li>
</ul>
<ol start="4">
<li>远程机的管理员需要设置。</li>
</ol>
<ul>
<li>在<strong>/etc/ssh/sshd_config</strong>，设置PubkeyAuthentication yes。</li>
<li>service sshd reload。 重载ssh服务配置。</li>
</ul>
<blockquote>
<p>普通用户就是上面第3步。没其他多余操作。需要注意的是 .ssh目录的权限要设置为700，authorized_keys文件， u权限rw, g和o权限最多r，设置为600即可。具体man sshd（我没看过）。</p>
</blockquote>
<h2 id="该连接了，我是用的手机"><a href="#该连接了，我是用的手机" class="headerlink" title="该连接了，我是用的手机"></a>该连接了，我是用的手机</h2><ol>
<li>方法一，我就打开了 阿里云app，进入控制台，选择ssh工具，添加主机，设置秘钥对连接，但是死活登录不上去。</li>
<li>方法二，后来，我进入app，控制台，在我的云产品中选择云服务器ECS，右侧的三个小点点，点击有ssh连接，用秘钥对连接，然后就连上了。</li>
<li>从此以后用方法一也可以连上了。</li>
</ol>
<blockquote>
<p>这是什么骚操作，我也理解不了。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://lxl1986.github.io/2018/12/21/ssh/" data-id="cjrbs3fjn001dycv9n6aj66t6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/">ssh</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/execution-context/">execution context</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/prototype/">prototype</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cryptography/">cryptography</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/events/">events</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/events-load/">events load</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/height/">height</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scroll/">scroll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selector/">selector</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewport/">viewport</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/不知所云/">不知所云</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/cryptography/" style="font-size: 10px;">cryptography</a> <a href="/tags/css/" style="font-size: 16.67px;">css</a> <a href="/tags/events/" style="font-size: 13.33px;">events</a> <a href="/tags/events-load/" style="font-size: 10px;">events load</a> <a href="/tags/height/" style="font-size: 10px;">height</a> <a href="/tags/scroll/" style="font-size: 10px;">scroll</a> <a href="/tags/selector/" style="font-size: 10px;">selector</a> <a href="/tags/server/" style="font-size: 10px;">server</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/viewport/" style="font-size: 10px;">viewport</a> <a href="/tags/不知所云/" style="font-size: 13.33px;">不知所云</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/24/scrollLeft/">scrollLeft</a>
          </li>
        
          <li>
            <a href="/2019/01/21/a-little-note-about-load-event/">a little note about load event</a>
          </li>
        
          <li>
            <a href="/2019/01/18/event-fired/">event fired?</a>
          </li>
        
          <li>
            <a href="/2019/01/17/checkbox-notes/">checkbox notes</a>
          </li>
        
          <li>
            <a href="/2019/01/07/funargs/">funargs</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 李小利<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>